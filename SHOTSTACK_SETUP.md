# Shotstack API Integration Setup

This project now includes complete video generation capabilities using the Shotstack API with Firebase Storage for audio management. Here's how to set it up:

## 1. Environment Variables

Create a `.env.local` file in your project root with the following variables:

```bash
# Shotstack API Configuration
SHOTSTACK_API_KEY=your_shotstack_api_key_here
SHOTSTACK_HOST=https://api.shotstack.io/stage  # or https://api.shotstack.io/prod for production

# OpenAI API Configuration
OPENAI_API_KEY=your_openai_api_key_here

# Firebase Configuration (already configured in lib/firebase.js)
# No additional environment variables needed for Firebase
```

## 2. Get Your API Keys

### Shotstack API Key
1. Sign up at [shotstack.io](https://shotstack.io)
2. Go to your dashboard
3. Copy your API key from the API section
4. **Important**: Use `https://api.shotstack.io/stage` for testing and `https://api.shotstack.io/prod` for production

### OpenAI API Key
1. Go to [platform.openai.com](https://platform.openai.com)
2. Navigate to API Keys
3. Create a new API key

### Firebase Configuration
Firebase is already configured in your project with:
- Project ID: `foss-mentoring`
- Storage Bucket: `foss-mentoring.appspot.com`
- Authentication and Firestore enabled

## 3. Features Implemented

### Video Generation Pipeline
- **Text-to-Speech**: Uses OpenAI TTS API to convert script to audio
- **Firebase Storage**: Automatically uploads generated audio to Firebase Storage bucket
- **Video Composition**: Creates video timeline with multiple tracks using Shotstack SDK
- **Background Music**: Integrates selected music tracks from your music library
- **Built-in Captions**: Uses Shotstack's native caption generation system
- **Aspect Ratios**: Supports multiple video dimensions (1:1, 16:9, 9:16, 4:3, 3:4)

### API Endpoints
- `POST /api/generate` - Submit video generation job
- `GET /api/status?id=<job_id>` - Check job status

### Frontend Features
- Real-time job status monitoring
- Progress tracking with visual indicators
- Audio URL display for debugging
- Download links when videos are ready
- Error handling and user feedback

## 4. How It Works

1. **User submits script** with voice, music, and caption preferences
2. **OpenAI TTS** generates audio from the script
3. **Firebase Storage** uploads the audio file and returns a public URL
4. **Shotstack composition** creates video timeline using proper SDK classes:
   - Background color/video
   - TTS audio track (from Firebase Storage URL)
   - Background music (if selected)
   - Caption overlays (generated by Shotstack)
5. **Video rendering** processes the composition
6. **Status monitoring** tracks progress and provides download links

## 5. Shotstack SDK Implementation

The system now uses the official Shotstack Node.js SDK with proper classes:

- **`Shotstack.ApiClient`** - Base client configuration
- **`Shotstack.EditApi`** - Main API for video editing operations
- **`Shotstack.Timeline`** - Timeline composition
- **`Shotstack.Track`** - Individual tracks in the timeline
- **`Shotstack.Clip`** - Video/audio clips
- **`Shotstack.ColorAsset`** - Background colors
- **`Shotstack.AudioAsset`** - Audio files
- **`Shotstack.TitleAsset`** - Text overlays and captions
- **`Shotstack.Output`** - Video output configuration

## 6. Audio Storage

- **Storage Location**: Firebase Storage bucket (`foss-mentoring.appspot.com`)
- **File Structure**: `audio/tts-audio-{timestamp}-{random}.mp3`
- **Access**: Public URLs for Shotstack to access
- **Cache Control**: 1 hour cache for performance
- **File Naming**: Unique timestamps prevent conflicts

## 7. Caption System

- **Generation**: Shotstack handles caption rendering automatically
- **Styling**: User selects caption style (minimal, modern, etc.)
- **Positioning**: Top, center, or bottom alignment
- **Content**: Full script text displayed throughout video duration
- **Customization**: Color, size, and style options

## 8. Video Output

- **Format**: MP4
- **Quality**: Based on resolution (configurable)
- **FPS**: 30
- **Resolution**: Based on selected aspect ratio
  - 1:1 → 1080x1080
  - 16:9 → 1920x1080
  - 9:16 → 1080x1920
  - 4:3 → 1440x1080
  - 3:4 → 1080x1440

## 9. Testing

1. Start your development server: `npm run dev`
2. Fill out the form with a script
3. Select voice, music, and caption options
4. Click "Generate video"
5. Monitor the status in the bottom-right corner
6. Check Firebase Storage for uploaded audio files
7. Download your video when complete

## 10. Production Considerations

- **Environment**: Switch from `stage` to `prod` in SHOTSTACK_HOST
- **Firebase Storage Rules**: Configure appropriate security rules for production
- **Audio Cleanup**: Implement cleanup policies for old audio files
- **Callback URLs**: Set up webhook endpoints for production status updates
- **Error Handling**: Add retry logic and better error recovery
- **Rate Limiting**: Implement API rate limiting for production use
- **Security**: Add authentication and authorization for API endpoints

## 11. Troubleshooting

### Common Issues
- **API Key Errors**: Ensure your environment variables are set correctly
- **TTS Failures**: Check OpenAI API key and quota
- **Firebase Storage Errors**: Verify Firebase configuration and storage rules
- **Render Failures**: Verify Shotstack API key and account status
- **Status Monitoring**: Check browser console for API errors

### Debug Mode
Enable detailed logging by checking the browser console and server logs for detailed error information.

### Firebase Storage Monitoring
- Check Firebase Console > Storage for uploaded audio files
- Monitor storage usage and costs
- Review storage rules and permissions

### Shotstack Dashboard
- Monitor render jobs in your Shotstack dashboard
- Check API usage and quotas
- Review render logs for debugging
